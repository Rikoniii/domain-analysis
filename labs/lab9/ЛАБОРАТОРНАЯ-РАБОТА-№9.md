# Лабораторная работа №9: Генерация тестовых данных

## Цель работы

Создать систему генерации тестовых данных для проекта приюта "Дом Лап" с использованием инструментов для автоматической генерации данных. Обеспечить валидность и целостность генерируемых данных, а также проверить корректность работы базы данных с большими объемами тестовых данных.

## Задачи

1. Выбрать и установить инструмент для генерации тестовых данных
2. Создать скрипт генерации данных для всех основных таблиц БД
3. Реализовать валидацию генерируемых данных
4. Проверить целостность базы данных после генерации
5. Документировать процесс генерации данных

## Выполнение работы

### 1. Выбор инструмента

Для генерации тестовых данных был выбран **Faker** — библиотека Python для генерации фейковых данных.

**Преимущества Faker:**
- Простота использования и интеграции с Python
- Поддержка различных локалей (включая русскую)
- Активная разработка и поддержка
- Не требует внешних сервисов
- Хорошая документация

**Альтернативные инструменты (рассмотренные):**
- Mockaroo — веб-сервис, требует интернет-соединение
- factory_boy — больше подходит для Django
- Hypothesis — для property-based тестирования, избыточен для данной задачи

### 2. Установка зависимостей

Добавлен Faker в `requirements.txt`:

```txt
Faker==24.0.0
```

Установка:
```bash
pip install -r requirements.txt
```

### 3. Создание скрипта генерации данных

Создан файл `backend/generate_test_data.py` со следующими функциями:

#### 3.1. Генерация пользователей (`generate_user`)

- Генерирует уникальные номера телефонов в формате +7XXXXXXXXXX
- Создает русские имена и фамилии
- Генерирует email адреса (90% пользователей имеют email)
- Устанавливает случайные даты создания за последний год

**Особенности:**
- Проверка уникальности телефонов
- Автоматическая нормализация номеров
- Обработка конфликтов при дубликатах

#### 3.2. Генерация способов оплаты (`generate_payment_method`)

- Связывает с существующими пользователями
- Генерирует токены платежных методов (70% имеют токен)
- Создает последние 4 цифры карты (80% имеют)
- Распределяет активные/неактивные методы (75% активны)

#### 3.3. Генерация пожертвований (`generate_donation`)

- Создает пожертвования от 100 до 50,000 рублей
- 80% связаны с пользователями, 20% анонимные
- Распределяет статусы: pending, succeeded, canceled, failed
- 30% связаны с подписками (регулярные пожертвования)
- Устанавливает даты за последние 6 месяцев

#### 3.4. Генерация подписок (`generate_subscription`)

- Создает подписки от 200 до 10,000 рублей
- Частоты: weekly, monthly, quarterly
- Статусы: active, canceled, paused
- Автоматически создает пожертвования для активных подписок
- Корректно рассчитывает даты следующего списания

### 4. Валидация данных

Реализована функция `validate_database`, которая проверяет:

1. **Уникальность данных:**
   - Номера телефонов пользователей не дублируются

2. **Валидность сумм:**
   - Все пожертвования >= 100 рублей (минимальная сумма)

3. **Целостность связей:**
   - Пожертвования ссылаются на существующих пользователей
   - Подписки ссылаются на существующих пользователей
   - Подписки ссылаются на существующие способы оплаты
   - Способы оплаты ссылаются на существующих пользователей

### 5. Использование скрипта

#### Базовое использование:
```bash
python backend/generate_test_data.py
```

Создает по умолчанию:
- 50 пользователей
- 200 пожертвований
- 30 подписок
- 40 способов оплаты

#### Настройка количества:
```bash
python backend/generate_test_data.py 100 500 50 80
```

Параметры: `<пользователи> <пожертвования> <подписки> <способы_оплаты>`

### 6. Проверка результатов

После генерации данных выводится:
- Статистика по количеству созданных записей
- Количество активных подписок
- Количество успешных пожертвований
- Общая сумма пожертвований
- Результаты валидации

## Результаты

### Созданные файлы:

1. **`backend/generate_test_data.py`** — основной скрипт генерации данных
2. **`tests/lab9/README.md`** — подробная документация по использованию
3. **`tests/lab9/ЛАБОРАТОРНАЯ-РАБОТА-№9.md`** — этот файл с описанием работы

### Обновленные файлы:

1. **`backend/requirements.txt`** — добавлен Faker==24.0.0

### Пример работы скрипта:

```
============================================================
  Генератор тестовых данных для приюта 'Дом Лап'
============================================================

[INFO] Генерация пользователей: 50
  Создано пользователей: 10/50
  ...
  Создано пользователей: 50/50

[INFO] Генерация способов оплаты: 40
  ...

[INFO] Генерация подписок: 30
  ...

[INFO] Генерация пожертвований: 200
  ...

[INFO] Валидация данных...
[OK] Валидация пройдена успешно!

============================================================
  Статистика сгенерированных данных:
============================================================
  Пользователей: 50
  Способов оплаты: 40
  Подписок: 30
  Пожертвований: 200

  Активных подписок: 18
  Успешных пожертвований: 145
  Общая сумма пожертвований: 2,345,678.90 ₽

============================================================
  Генерация данных завершена успешно!
============================================================
```

## Проверка целостности БД

После генерации данных выполнена проверка:

1. ✅ Все пользователи имеют уникальные телефоны
2. ✅ Все пожертвования имеют сумму >= 100 рублей
3. ✅ Все связи между таблицами корректны
4. ✅ Нет "осиротевших" записей (orphan records)

## Выводы

1. **Успешно реализована система генерации тестовых данных** с использованием библиотеки Faker
2. **Создан универсальный скрипт**, который может генерировать различные объемы данных
3. **Реализована валидация данных**, обеспечивающая целостность БД
4. **Данные генерируются реалистично** благодаря использованию русской локали Faker
5. **Система готова к использованию** для тестирования и разработки

## Рекомендации

1. Использовать генератор данных перед запуском тестов
2. Периодически проверять целостность БД после генерации
3. Настраивать объем данных в зависимости от задач (тестирование vs демонстрация)
4. Сохранять резервные копии БД перед генерацией больших объемов данных

## Используемые технологии

- **Python 3.x** — язык программирования
- **Faker 24.0.0** — библиотека генерации данных
- **SQLAlchemy 2.0.23** — ORM для работы с БД
- **SQLite** — база данных

## Источники

- [Документация Faker](https://faker.readthedocs.io/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- Документация проекта приюта "Дом Лап"

