## Лабораторная работа №8

**Тема:** Юнит‑тестирование компонентов веб‑приложения «Дом Лап»

---

### 1. Цель работы

- **Освоить подходы к юнит‑тестированию** на примере реального проекта.
- **Научиться писать позитивные и негативные тест‑кейсы** для функций и обработчиков API.
- **Освоить использование инструмента тестирования `pytest`** для Python‑проекта.

---

### 2. Инструменты юнит‑тестирования

Для бекенда приложения, написанного на **Python (Flask + SQLAlchemy)**, в качестве инструмента юнит‑тестирования выбран **`pytest`**, так как он:

- прост в использовании и не требует наследования от базовых классов;
- поддерживает удобные **fixtures** для подготовки окружения;
- хорошо интегрируется с существующей структурой проекта.

Команда для запуска тестов (из корня проекта):

```bash
pytest
```

При необходимости можно ограничить запуск только тестами для ЛР8:

```bash
pytest tests/lab8/
```

Или запустить тесты для конкретного модуля:

```bash
pytest tests/lab8/test_functions.py
pytest tests/lab8/test_api.py
```

---

### 3. Выбранные для тестирования функции

Для ЛР8 выбраны функции из файла `backend/app.py`, которые:
- не требуют реального подключения к внешним сервисам (YooMoney, SMS и т.п.);
- имеют чётко определённую бизнес‑логику, удобную для изолированного тестирования.

**Выбранные функции:**

1. `calculate_next_charge_date(frequency: str, from_date: Optional[datetime] = None) -> datetime`  
   - Назначение: вычисление даты следующего списания регулярного пожертвования.

2. `generate_code(length=4) -> str`  
   - Назначение: генерация цифрового кода подтверждения для SMS/звонка.

3. `generate_session_id() -> str`  
   - Назначение: генерация уникального идентификатора сессии подтверждения.

4. Обработчик `verify_code` (`/api/auth/verify-code`)  
   - Назначение: проверка корректности введённого кода подтверждения на основе данных во временном хранилище `verification_sessions`.

---

### 4. Структура тестов

Тесты для ЛР8 организованы в отдельной папке `tests/lab8/` и разделены на два модуля:

- **`tests/lab8/test_functions.py`** — юнит‑тесты для утилитарных функций (`calculate_next_charge_date`, `generate_code`, `generate_session_id`).
- **`tests/lab8/test_api.py`** — юнит‑тесты для API эндпоинтов (обработчик `/api/auth/verify-code`).

Все тесты содержат подробные комментарии, описывающие:
- назначение теста (позитивный/негативный/граничный);
- сценарий использования;
- ожидаемое поведение функции/эндпоинта;
- пояснения к проверкам.

Используется следующий набор тестов:

- **Позитивные тесты** — корректные входные данные, ожидаемое «нормальное» поведение.
- **Негативные тесты** — некорректные или граничные значения, ожидаемые ошибки/отказы.

#### 4.1. Тесты для `calculate_next_charge_date`

- **Позитивные сценарии:**
  - `test_calculate_next_charge_date_weekly` — при частоте `weekly` дата сдвигается ровно на 7 дней.
  - `test_calculate_next_charge_date_monthly` — при частоте `monthly` дата сдвигается на 1 календарный месяц.
  - `test_calculate_next_charge_date_quarterly` — при частоте `quarterly` дата сдвигается на 3 календарных месяца.
  - `test_calculate_next_charge_date_default_for_unknown_frequency` — при неизвестной частоте используется значение «по умолчанию» (1 месяц).

- **Негативные/граничные сценарии:**
  - `test_calculate_next_charge_date_uses_utc_now_when_from_date_none` — передаётся `from_date=None`, функция должна использовать `datetime.utcnow()` и не падать с ошибкой.

#### 4.2. Тесты для `generate_code`

- **Позитивные сценарии:**
  - `test_generate_code_default_length` — код по умолчанию состоит ровно из 4 символов.
  - `test_generate_code_custom_length` — при передаче другого `length` (например, 6) код имеет соответствующую длину.
  - `test_generate_code_digits_only` — все символы кода являются цифрами.

- **Негативные/граничные сценарии:**
  - `test_generate_code_zero_length` — при длине 0 возвращается пустая строка (корректная обработка граничного случая).

#### 4.3. Тесты для `generate_session_id`

- **Позитивные сценарии:**
  - `test_generate_session_id_length` — сгенерированный идентификатор всегда длиной 32 символа.
  - `test_generate_session_id_alphanumeric` — идентификатор состоит только из латинских букв и цифр.
  - `test_generate_session_id_uniqueness` — при многократном вызове функция возвращает разные значения (отсутствие коллизий в небольшом наборе).

#### 4.4. Тесты для обработчика `/api/auth/verify-code`

Для тестирования используется **тестовый клиент Flask**, создаваемый через `app.test_client()`, а также прямое заполнение словаря `verification_sessions` перед вызовом эндпоинта.

- **Позитивный сценарий:**
  - `test_verify_code_success` — при передаче корректных `session_id` и `code`, не истекшем времени и наличии записи в `verification_sessions` эндпоинт возвращает `200 OK` и `{"verified": true, "phone": ...}`.

- **Негативные сценарии:**
  - `test_verify_code_missing_parameters` — при отсутствии `session_id` или `code` возвращается ошибка `400` и сообщение о том, что параметры обязательны.
  - `test_verify_code_session_not_found` — при несуществующем `session_id` возвращается ошибка `404`.
  - `test_verify_code_expired` — при истёкшем сроке действия записи (прошло больше 5 минут) возвращается ошибка `400` и сообщение «Код истек».
  - `test_verify_code_wrong_code` — при неверном коде возвращается ошибка `400` и сообщение «Неверный код».

---

### 5. Структура проекта с тестами

```text
proekt/
  backend/
    app.py
    database.py
    __init__.py        # добавлен для возможности импорта модуля backend из тестов
  docs/
    ЛАБОРАТОРНАЯ-РАБОТА-№7.md
    ЛАБОРАТОРНАЯ-РАБОТА-№8.md
  tests/
    lab8/
      __init__.py      # модуль тестов для ЛР8
      test_functions.py  # тесты для утилитарных функций
      test_api.py        # тесты для API эндпоинтов
```

**Особенности организации тестов:**

- Тесты разделены по функциональности: утилитарные функции и API эндпоинты.
- Каждый тест содержит подробные комментарии с описанием сценария и ожидаемого поведения.
- Используются docstrings для документирования назначения каждого теста.
- Комментарии в коде объясняют логику проверок и используемые тестовые данные.

---

### 6. Выводы

В ходе выполнения лабораторной работы №8 были:

- выбраны функции и обработчики API, содержащие бизнес‑логику (расчёт дат списаний, генерация кодов и сессий, проверка кода подтверждения);
- разработан набор **юнит‑тестов с позитивными и негативными сценариями** на основе инструмента `pytest`;
- организована структура проекта с каталогом `tests` и возможностью запуска тестов одной командой.

Юнит‑тестирование позволило формализовать требования к функциям и убедиться, что они корректно обрабатывают типичные, граничные и некорректные входные данные.


