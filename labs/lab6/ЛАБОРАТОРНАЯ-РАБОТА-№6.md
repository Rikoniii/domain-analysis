# Лабораторная работа №6

## Интеграция сторонних сервисов

В данном проекте реализованы две сторонние интеграции:

1. **Яндекс.Карты** - для отображения карты расположения приюта
2. **YooMoney (ЮMoney)** - платежная система для обработки пожертвований

---

## 1. Интеграция Яндекс.Карт

### Описание

Яндекс.Карты используются на странице "О приюте" (`about.html`) для отображения карты с расположением приюта. Это позволяет пользователям легко найти адрес приюта и построить маршрут.

### Как это реализовано

#### Технические детали

Интеграция реализована через **встраивание виджета Яндекс.Карт** (iframe), что не требует API ключа и позволяет использовать карты бесплатно для базовых задач.

**Файлы:**
- `frontend/about.html` - HTML разметка с контейнером для карты
- `frontend/js/about.js` - JavaScript код инициализации карты
- `frontend/css/style.css` - стили для контейнера карты

#### Реализация

**1. HTML разметка** (`about.html`):
```html
<div class="contact-map-modern">
    <div class="map-wrapper">
        <div id="yandex-map"></div>
    </div>
</div>
```

**2. JavaScript инициализация** (`about.js`, функция `initYandexMap()`):

```javascript
function initYandexMap() {
    const mapContainer = document.getElementById('yandex-map');
    if (!mapContainer) return;
    
    // Использование встраивания Яндекс.Карт без API ключа
    const address = encodeURIComponent('Москва, ул. Добрая, д. 1');
    const embedUrl = `https://yandex.ru/map-widget/v1/?ll=37.6800%2C55.7887&z=15&pt=37.6800%2C55.7887&text=${address}`;
    
    mapContainer.innerHTML = `
        <iframe 
            src="${embedUrl}" 
            width="100%" 
            height="500" 
            frameborder="0" 
            style="border-radius: 16px; border: none;"
            allowfullscreen="true"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            title="Карта расположения приюта">
        </iframe>
    `;
}
```

**Параметры URL:**
- `ll=37.6800,55.7887` - координаты центра карты (долгота, широта)
- `z=15` - уровень масштабирования
- `pt=37.6800,55.7887` - координаты метки
- `text=...` - адрес для поиска

**3. Обработка ошибок:**

В коде реализована обработка ошибок загрузки карты, так как некоторые браузерные расширения (блокировщики рекламы) могут блокировать загрузку ресурсов Яндекс.Карт.

```javascript
iframe.addEventListener('error', function() {
    console.log('Map iframe: Some resources may be blocked - this is normal');
});
```

### Преимущества данного подхода

- ✅ **Не требует API ключа** - можно использовать бесплатно
- ✅ **Простая интеграция** - достаточно встроить iframe
- ✅ **Автоматическое обновление** - карты всегда актуальные
- ✅ **Мобильная адаптация** - карты адаптируются под размер экрана

### Ограничения

- ⚠️ Меньше возможностей кастомизации по сравнению с JavaScript API
- ⚠️ Нет возможности программно управлять картой (изменять масштаб, добавлять маркеры через код)

### Где используется

Карта отображается на странице **"О приюте"** (`/frontend/about.html`) в разделе контактов, рядом с информацией о часах работы и способах связи.

---

## 2. Интеграция платежной системы YooMoney (ЮMoney)

### Описание

YooMoney интегрирована для обработки пожертвований в приюте. Система поддерживает:
- Разовые пожертвования
- Регулярные (подписочные) пожертвования
- Различные способы оплаты: банковские карты, ЮMoney кошелек, PayPal, СБП

### Как это реализовано

#### Архитектура

Система работает в двух режимах:
1. **Демо-режим** (для разработки) - платежи не списываются реально, но вся логика работает
2. **Продакшен-режим** (с YooMoney API) - реальные платежи через платежный шлюз

**Почему два режима?** Это позволяет разрабатывать и тестировать функционал без реальных списаний, а затем легко переключиться на реальные платежи.

#### Технические детали

**Файлы:**
- `backend/app.py` - API эндпоинты и интеграция с YooMoney
- `frontend/donate.html` - страница пожертвований
- `frontend/js/donate.js` - клиентская логика обработки платежей
- `backend/database.py` - модели БД для пожертвований и подписок
- `docs/ПЛАТЕЖИ.md` - подробная документация по платежам

#### Backend реализация

**1. Функция создания платежа** (`backend/app.py`):

```python
def create_yoomoney_payment(
    amount: float,
    description: str,
    return_url: str,
    metadata: Dict[str, Any],
    payment_method: str = 'card'
) -> Dict[str, Any]:
    """
    Создать платеж в YooMoney
    
    Документация: https://yoomoney.ru/docs/payment-buttons/using-api/payment-process
    """
    if not YOOMONEY_SHOP_ID or not YOOMONEY_SECRET_KEY:
        # Демо-режим: возвращаем мок-ответ
        return {
            'id': f'mock_payment_{payment_method}_{datetime.utcnow().timestamp()}',
            'status': 'pending',
            'confirmation': {
                'type': 'redirect',
                'confirmation_url': f'{BASE_URL}/frontend/donate.html?mock_payment=success'
            }
        }
    
    # Реальная интеграция с YooMoney API
    url = 'https://yoomoney.ru/api/v3/payments'
    headers = {
        'Authorization': f'Bearer {YOOMONEY_SECRET_KEY}',
        'Content-Type': 'application/json'
    }
    
    data = {
        'amount': {
            'value': str(amount),
            'currency': 'RUB'
        },
        'confirmation': {
            'type': 'redirect',
            'return_url': return_url
        },
        'description': description,
        'metadata': metadata,
        'capture': True,
        'payment_method_data': {
            'type': payment_type  # bank_card, yoo_money, sbp и т.д.
        }
    }
    
    response = requests.post(url, json=data, headers=headers)
    return response.json()
```

**2. API эндпоинт создания пожертвования** (`POST /api/donations`):

```python
@app.route('/api/donations', methods=['POST'])
def create_donation():
    """Создать донат и инициировать платеж в YooMoney"""
    data = request.get_json()
    
    # Создаем запись в БД
    donation = Donation(
        amount=data['amount'],
        donor_name=data.get('donor_name'),
        donor_phone=data.get('donor_phone'),
        donor_email=data.get('donor_email'),
        payment_method=data.get('payment_method', 'card'),
        is_recurring=data.get('is_recurring', False),
        status='pending'
    )
    
    # Создаем платеж в YooMoney
    payment_response = create_yoomoney_payment(
        amount=data['amount'],
        description=f"Пожертвование в приют: {data.get('donor_name', 'Анонимно')}",
        return_url=f"{BASE_URL}/frontend/donate.html",
        metadata={'donation_id': donation.id},
        payment_method=data.get('payment_method', 'card')
    )
    
    # Сохраняем ID платежа
    donation.provider_payment_id = payment_response.get('id')
    
    return jsonify({
        'donation_id': donation.id,
        'payment_url': payment_response.get('confirmation', {}).get('confirmation_url')
    })
```

**3. Webhook обработчик** (`POST /api/yoomoney/webhook`):

YooMoney отправляет уведомления о статусе платежей через webhook:

```python
@app.route('/api/yoomoney/webhook', methods=['POST'])
def yoomoney_webhook():
    """Обработка webhook от YooMoney о статусе платежа"""
    signature = request.headers.get('X-YooMoney-Signature', '')
    data = request.get_json()
    
    # Проверяем подпись (в продакшене)
    if not verify_yoomoney_webhook(data, signature):
        return jsonify({'error': 'Invalid signature'}), 401
    
    # Обновляем статус пожертвования в БД
    payment_id = data.get('object', {}).get('id')
    donation = session.query(Donation).filter_by(provider_payment_id=payment_id).first()
    
    if donation:
        donation.status = 'completed' if data.get('event') == 'payment.succeeded' else 'failed'
        
        # Если это регулярное пожертвование, создаем подписку
        if donation.is_recurring and donation.status == 'completed':
            create_subscription(donation)
    
    return jsonify({'status': 'ok'})
```

#### Frontend реализация

**1. Страница пожертвований** (`frontend/donate.html`):

Пользователь выбирает:
- Сумму пожертвования (предустановленные или произвольную)
- Способ оплаты (карта, ЮMoney, PayPal, СБП)
- Регулярность (разовое или регулярное)
- Данные донора

**2. Обработка платежа** (`frontend/js/donate.js`):

```javascript
async function processDonationPayment(donationData) {
    // Отправляем запрос на API
    const response = await fetch('http://localhost:5000/api/donations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(donationData)
    });
    
    const result = await response.json();
    
    // Если есть URL платежа, перенаправляем пользователя
    if (result.payment_url && !result.payment_url.includes('mock_payment')) {
        window.location.href = result.payment_url;
    } else {
        // В демо-режиме показываем успешное сообщение
        showSuccessPaymentModal(donationData.amount);
    }
}
```

**3. Модальное окно оплаты картой:**

Для улучшения UX при оплате картой открывается модальное окно, где пользователь может:
- Выбрать сохраненную карту (если авторизован)
- Ввести данные новой карты
- Сохранить карту для будущих платежей

### Поддерживаемые способы оплаты

1. **Банковская карта** (`payment_method: 'card'`)
   - Visa, MasterCard, МИР
   - Модальное окно для ввода данных
   - Возможность сохранения карты

2. **ЮMoney кошелек** (`payment_method: 'yoomoney'`)
   - Прямой перевод с кошелька ЮMoney

3. **PayPal** (`payment_method: 'paypal'`)
   - Международные платежи

4. **СБП (Система быстрых платежей)** (`payment_method: 'sbp'`)
   - QR-код для оплаты через банковское приложение

### База данных

Система использует следующие таблицы:

- **`donations`** - разовые пожертвования
  - `id`, `amount`, `donor_name`, `donor_phone`, `donor_email`
  - `payment_method`, `status`, `provider_payment_id`
  - `is_recurring`, `created_at`

- **`subscriptions`** - регулярные пожертвования
  - `id`, `user_id`, `donation_id`
  - `amount`, `frequency` (weekly/monthly)
  - `next_charge_date`, `is_active`

- **`payment_methods`** - сохраненные способы оплаты
  - `id`, `user_id`, `provider`
  - `provider_payment_token`, `last4`
  - `is_active`

### Настройка для продакшена

Для работы с реальными платежами необходимо:

1. **Получить ключи YooMoney:**
   - Зарегистрироваться в [YooMoney для бизнеса](https://yoomoney.ru/business)
   - Получить Shop ID и Secret Key

2. **Настроить переменные окружения** (`.env`):
```env
YOOMONEY_SHOP_ID=your_shop_id
YOOMONEY_SECRET_KEY=your_secret_key
YOOMONEY_WEBHOOK_SECRET=your_webhook_secret
BASE_URL=https://your-domain.com
```

3. **Настроить webhook URL** в личном кабинете YooMoney:
```
https://your-domain.com/api/yoomoney/webhook
```

4. **Настроить HTTPS** (обязательно для webhook)

5. **Настроить крон-джоб** для обработки регулярных списаний

Подробная инструкция по настройке находится в файле `docs/ПЛАТЕЖИ.md`.

### Безопасность

⚠️ **Важно для продакшена:**

- Секретные ключи хранятся в переменных окружения (не в коде)
- Проверка подписи webhook для защиты от подделок
- Данные карт не хранятся на сервере (используется токенизация)
- CVC код никогда не сохраняется
- HTTPS обязателен для передачи платежных данных

### Преимущества интеграции

- ✅ **Множество способов оплаты** - карты, ЮMoney, PayPal, СБП
- ✅ **Регулярные пожертвования** - автоматические списания
- ✅ **Демо-режим** - разработка без реальных платежей
- ✅ **Webhook уведомления** - автоматическое обновление статусов
- ✅ **Российский провайдер** - оптимально для российских пользователей

### Документация

- [Документация YooMoney API](https://yoomoney.ru/docs/payment-buttons/using-api/payment-process)
- [Webhook документация](https://yoomoney.ru/docs/payment-buttons/using-api/webhooks)
- [Подробная документация проекта](docs/ПЛАТЕЖИ.md)

---

## Итоги

В проекте успешно интегрированы два сторонних сервиса:

1. **Яндекс.Карты** - для удобного отображения местоположения приюта
2. **YooMoney** - для полноценной обработки пожертвований с поддержкой различных способов оплаты

Обе интеграции работают и готовы к использованию. Яндекс.Карты работают сразу без настройки, а YooMoney имеет демо-режим для разработки и может быть легко переключена на продакшен после настройки ключей.

